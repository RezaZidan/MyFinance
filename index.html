<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MyFinance - Home</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        background-color: #f5f6fa;
        padding-bottom: 70px;
        font-family: "Segoe UI", sans-serif;
      }
      .top-navbar {
        background: linear-gradient(45deg, #0d6efd, #2b8cff);
        color: white;
      }
      .saldo-box {
        font-size: 1.8rem;
        font-weight: bold;
        color: #0d6efd;
      }
      .card {
        border-radius: 15px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      }
      .transaction-item {
        background: #fff;
        padding: 12px;
        border-radius: 12px;
        margin-bottom: 10px;
        border: 1px solid #eee;
      }
      .bottom-navbar {
        background-color: white;
        border-top: 1px solid #ddd;
        padding: 5px 0;
      }
      .bottom-navbar a {
        color: #6c757d;
        text-decoration: none;
      }
      .bottom-navbar a.active {
        color: #0d6efd;
      }
      #notifBulanan {
        margin-top: 10px;
        font-size: 0.9rem;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <!-- Navbar Atas -->
    <nav class="navbar top-navbar p-3">
      <div class="container-fluid d-flex align-items-center">
        <i class="bi bi-wallet2 fs-3 me-2"></i>
        <span class="h5 mb-0">MyFinance</span>
      </div>
    </nav>

    <div class="container mt-3">
      <!-- Total Saldo -->
      <div class="card mb-3 text-center">
        <div class="card-body">
          <h6 class="text-muted">Total Saldo</h6>
          <div id="totalSaldo" class="saldo-box">Rp 0</div>
        </div>
      </div>

      <!-- Ringkasan Bulanan (Chart) -->
      <div class="card mb-3">
        <div class="card-header bg-light fw-bold">
          <i class="bi bi-graph-up"></i> Ringkasan Bulanan
        </div>
        <div class="card-body">
          <canvas id="chartBulanan" height="120"></canvas>
          <div id="notifBulanan" class="text-muted text-center"></div>
        </div>
      </div>

      <!-- Daftar Dompet -->
      <div class="card mb-3">
        <div class="card-header bg-light fw-bold">
          <i class="bi bi-wallet2"></i> Dompet
        </div>
        <div class="card-body" id="dompetList"></div>
      </div>

      <!-- Pemasukan -->
      <div class="card mb-3 text-success text-center">
        <div class="card-body">
          <i class="bi bi-arrow-down-circle-fill fs-2"></i>
          <h6>Pemasukan</h6>
          <div id="totalPemasukan" class="fs-5 fw-bold">Rp 0</div>
        </div>
      </div>

      <!-- Pengeluaran -->
      <div class="card mb-3 text-danger text-center">
        <div class="card-body">
          <i class="bi bi-arrow-up-circle-fill fs-2"></i>
          <h6>Pengeluaran</h6>
          <div id="totalPengeluaran" class="fs-5 fw-bold">Rp 0</div>
        </div>
      </div>

      <!-- Laporan -->
      <div class="card mb-3">
        <div class="card-header bg-light fw-bold">
          <i class="bi bi-bar-chart"></i> Laporan
        </div>
        <div class="card-body">
          <div class="row g-2 mb-3">
            <div class="col">
              <label for="startDate" class="form-label small">Dari</label>
              <input type="date" id="startDate" class="form-control" />
            </div>
            <div class="col">
              <label for="endDate" class="form-label small">Sampai</label>
              <input type="date" id="endDate" class="form-control" />
            </div>
          </div>
          <div class="row text-center">
            <div class="col">
              <small class="text-muted">Pemasukan</small>
              <div id="laporanPemasukan" class="fw-bold text-success">Rp 0</div>
            </div>
            <div class="col">
              <small class="text-muted">Pengeluaran</small>
              <div id="laporanPengeluaran" class="fw-bold text-danger">
                Rp 0
              </div>
            </div>
            <div class="col">
              <small class="text-muted">Selisih</small>
              <div id="laporanSelisih" class="fw-bold">Rp 0</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Target -->
      <div class="card mb-3">
        <div
          class="card-header d-flex justify-content-between align-items-center bg-light fw-bold"
        >
          <span><i class="bi bi-bullseye"></i> Target</span>
          <a href="target.html" class="small text-decoration-none"
            >Lihat semua</a
          >
        </div>
        <div class="card-body" id="targetPreview"></div>
      </div>

      <!-- Section Kategori -->
      <div class="container mt-4">
        <h6 class="fw-bold mb-2">Kategori</h6>
        <p class="text-muted">Kelola kategori pemasukan dan pengeluaran</p>

        <button
          class="btn btn-sm btn-primary mb-3"
          data-bs-toggle="modal"
          data-bs-target="#kategoriModal"
        >
          <i class="bi bi-plus-circle"></i> Tambah Kategori
        </button>

        <div id="kategoriList"></div>
      </div>

      <!-- Modal Tambah Kategori -->
      <div class="modal fade" id="kategoriModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Tambah Kategori Baru</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
              ></button>
            </div>
            <div class="modal-body">
              <form id="formKategori">
                <div class="mb-3">
                  <label class="form-label">Jenis</label>
                  <select class="form-select" id="kategoriJenis" required>
                    <option value="">-- Pilih Jenis --</option>
                    <option value="pemasukan">Pemasukan</option>
                    <option value="pengeluaran">Pengeluaran</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Nama Kategori</label>
                  <input
                    type="text"
                    class="form-control"
                    id="kategoriNama"
                    placeholder="Misal: Makan, Gaji..."
                    required
                  />
                </div>
                <button type="submit" class="btn btn-primary w-100">
                  Simpan
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>

      <script>
        let kategori = JSON.parse(localStorage.getItem("kategori")) || [
          { jenis: "pemasukan", nama: "Gaji" },
          { jenis: "pengeluaran", nama: "Makan" },
        ];

        function renderKategori() {
          const list = document.getElementById("kategoriList");
          list.innerHTML = "";

          if (kategori.length === 0) {
            list.innerHTML = `<p class="text-muted">Belum ada kategori.</p>`;
            return;
          }

          kategori.forEach((k, index) => {
            let badgeClass = k.jenis === "pemasukan" ? "success" : "danger";
            list.innerHTML += `
        <div class="card mb-2">
          <div class="card-body d-flex justify-content-between align-items-center">
            <div>
              <span class="badge bg-${badgeClass} text-capitalize">${k.jenis}</span>
              <span class="ms-2 fw-bold">${k.nama}</span>
            </div>
            <button class="btn btn-sm btn-outline-danger" onclick="hapusKategori(${index})">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </div>
      `;
          });
        }

        // Simpan kategori baru
        document
          .getElementById("formKategori")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            let jenis = document.getElementById("kategoriJenis").value;
            let nama = document.getElementById("kategoriNama").value.trim();

            if (!jenis || !nama) return;

            kategori.push({ jenis, nama });
            localStorage.setItem("kategori", JSON.stringify(kategori));

            renderKategori();
            e.target.reset();
            bootstrap.Modal.getInstance(
              document.getElementById("kategoriModal")
            ).hide();
          });

        function hapusKategori(index) {
          kategori.splice(index, 1);
          localStorage.setItem("kategori", JSON.stringify(kategori));
          renderKategori();
        }

        renderKategori();
      </script>

      <!-- Transaksi Terbaru -->
      <div class="card mb-3">
        <div
          class="card-header d-flex justify-content-between align-items-center bg-light fw-bold"
        >
          <span><i class="bi bi-clock-history"></i> Transaksi Terbaru</span>
          <a href="histori.html" class="small text-decoration-none"
            >Lihat semua</a
          >
        </div>
        <div class="card-body" id="transaksiTerbaru"></div>
      </div>
    </div>

    <!-- Navbar Bawah -->
    <nav class="navbar fixed-bottom bottom-navbar">
      <div class="container-fluid d-flex justify-content-around">
        <a href="index.html" class="text-center active"
          ><i class="bi bi-house fs-4"></i
        ></a>
        <a href="dompet.html" class="text-center"
          ><i class="bi bi-wallet2 fs-4"></i
        ></a>
        <a href="transaksi.html" class="text-center"
          ><i class="bi bi-plus-circle-fill fs-2 text-primary"></i
        ></a>
        <a href="budget.html" class="text-center"
          ><i class="bi bi-pie-chart fs-4"></i
        ></a>
        <a href="histori.html" class="text-center"
          ><i class="bi bi-clock-history fs-4"></i
        ></a>
      </div>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let dompet = JSON.parse(localStorage.getItem("dompet")) || [
        { nama: "Cash", saldo: 0 },
      ];
      let transaksi = JSON.parse(localStorage.getItem("transaksi")) || [];
      let target = JSON.parse(localStorage.getItem("target")) || [];

      function formatRp(num) {
        return "Rp " + num.toLocaleString("id-ID");
      }

      function renderHome() {
        // Total Saldo
        let totalSaldo = dompet.reduce((sum, d) => sum + d.saldo, 0);
        document.getElementById("totalSaldo").innerText = formatRp(totalSaldo);

        // Daftar dompet
        let dompetList = document.getElementById("dompetList");
        dompetList.innerHTML = "";
        dompet.forEach((d) => {
          dompetList.innerHTML += `<div class="d-flex justify-content-between mb-2">
          <span>${d.nama}</span><span class="fw-bold">${formatRp(
            d.saldo
          )}</span>
        </div>`;
        });

        // Hitung pemasukan/pengeluaran total
        let pemasukan = transaksi
          .filter((t) => t.jenis === "pemasukan")
          .reduce((s, t) => s + t.jumlah, 0);
        let pengeluaran = transaksi
          .filter((t) => t.jenis === "pengeluaran")
          .reduce((s, t) => s + t.jumlah, 0);
        document.getElementById("totalPemasukan").innerText =
          formatRp(pemasukan);
        document.getElementById("totalPengeluaran").innerText =
          formatRp(pengeluaran);

        // Render laporan default
        renderLaporan();

        // Render chart bulanan
        renderChartBulanan();

        // Render target preview (maks 3)
        let targetPreview = document.getElementById("targetPreview");
        targetPreview.innerHTML = "";
        target.slice(0, 3).forEach((t) => {
          let current = 0;
          t.dompetIndex.forEach((idx) => {
            if (dompet[idx]) current += dompet[idx].saldo;
          });

          let progress = Math.min((current / t.nominal) * 100, 100);
          targetPreview.innerHTML += `
          <div class="mb-2">
            <b>${t.nama}</b><br/>
            <small class="text-muted">Target: ${formatRp(
              t.nominal
            )} | Deadline: ${t.tanggal}</small>
            <div class="progress mt-1" style="height: 8px;">
              <div class="progress-bar ${
                progress >= 100 ? "bg-success" : "bg-primary"
              }" role="progressbar" style="width: ${progress}%"></div>
            </div>
            <small>Saat ini: ${formatRp(current)} (${progress.toFixed(
            1
          )}%)</small>
          </div>
        `;
        });
        if (target.length === 0) {
          targetPreview.innerHTML =
            "<small class='text-muted'>Belum ada target</small>";
        }

        // Transaksi terbaru (max 5)
        let terbaru = document.getElementById("transaksiTerbaru");
        terbaru.innerHTML = "";
        transaksi.slice(0, 5).forEach((t) => {
          terbaru.innerHTML += `
          <div class="transaction-item d-flex justify-content-between">
            <div>
              <b>${t.judul}</b>
              <span class="badge ${
                t.jenis === "pemasukan" ? "bg-success" : "bg-danger"
              }">${t.jenis}</span><br/>
              <small class="text-muted">${t.dompetNama} | ${t.tanggal}</small>
            </div>
            <div class="fw-bold ${
              t.jenis === "pemasukan" ? "text-success" : "text-danger"
            }">
              ${t.jenis === "pemasukan" ? "+" : "-"} ${formatRp(t.jumlah)}
            </div>
          </div>`;
        });
      }

      function renderLaporan() {
        let start = document.getElementById("startDate").value;
        let end = document.getElementById("endDate").value;

        let filtered = transaksi;
        if (start) filtered = filtered.filter((t) => t.tanggal >= start);
        if (end) filtered = filtered.filter((t) => t.tanggal <= end);

        let pemasukan = filtered
          .filter((t) => t.jenis === "pemasukan")
          .reduce((s, t) => s + t.jumlah, 0);
        let pengeluaran = filtered
          .filter((t) => t.jenis === "pengeluaran")
          .reduce((s, t) => s + t.jumlah, 0);

        document.getElementById("laporanPemasukan").innerText =
          formatRp(pemasukan);
        document.getElementById("laporanPengeluaran").innerText =
          formatRp(pengeluaran);
        document.getElementById("laporanSelisih").innerText = formatRp(
          pemasukan - pengeluaran
        );
      }

      // Chart Ringkasan Bulanan
      function renderChartBulanan() {
        let ctx = document.getElementById("chartBulanan").getContext("2d");

        // Ambil bulan sekarang & bulan lalu
        let now = new Date();
        let bulanIni = now.getMonth() + 1;
        let bulanLalu = bulanIni === 1 ? 12 : bulanIni - 1;
        let tahun = now.getFullYear();

        function sumByMonth(month, year, jenis) {
          return transaksi
            .filter((t) => {
              let d = new Date(t.tanggal);
              return (
                t.jenis === jenis &&
                d.getMonth() + 1 === month &&
                d.getFullYear() === year
              );
            })
            .reduce((s, t) => s + t.jumlah, 0);
        }

        let pemasukanIni = sumByMonth(bulanIni, tahun, "pemasukan");
        let pengeluaranIni = sumByMonth(bulanIni, tahun, "pengeluaran");
        let pemasukanLalu = sumByMonth(bulanLalu, tahun, "pemasukan");
        let pengeluaranLalu = sumByMonth(bulanLalu, tahun, "pengeluaran");

        // Chart
        new Chart(ctx, {
          type: "bar",
          data: {
            labels: ["Pemasukan", "Pengeluaran"],
            datasets: [
              {
                label: "Bulan Ini",
                data: [pemasukanIni, pengeluaranIni],
                backgroundColor: ["#28a745", "#dc3545"],
              },
              {
                label: "Bulan Lalu",
                data: [pemasukanLalu, pengeluaranLalu],
                backgroundColor: ["#7cd992", "#f28b82"],
              },
            ],
          },
          options: {
            responsive: true,
            plugins: { legend: { position: "bottom" } },
          },
        });

        // Notifikasi
        let notif = "";
        if (pengeluaranIni > pengeluaranLalu) {
          let persen = (
            ((pengeluaranIni - pengeluaranLalu) / (pengeluaranLalu || 1)) *
            100
          ).toFixed(1);
          notif = `⚠️ Pengeluaran bulan ini naik ${persen}% dibanding bulan lalu.`;
        } else if (pengeluaranIni < pengeluaranLalu) {
          let persen = (
            ((pengeluaranLalu - pengeluaranIni) / (pengeluaranLalu || 1)) *
            100
          ).toFixed(1);
          notif = `✅ Pengeluaran bulan ini turun ${persen}% dibanding bulan lalu.`;
        } else {
          notif = "ℹ️ Pengeluaran bulan ini sama dengan bulan lalu.";
        }
        document.getElementById("notifBulanan").innerText = notif;
      }

      document
        .getElementById("startDate")
        .addEventListener("change", renderLaporan);
      document
        .getElementById("endDate")
        .addEventListener("change", renderLaporan);

      renderHome();
    </script>
  </body>
</html>
